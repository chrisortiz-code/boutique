{% extends "base.html" %}
{% block title %}Update Inventory{% endblock %}
{% block extra_head %}
<style>
  .inv-card { display:flex; gap:1rem; align-items:center; padding:1rem; border:1px solid #ccc; border-radius:8px; margin-bottom:0.5rem; background:#fff; }
  .inv-thumb { width:80px; height:80px; display:flex; align-items:center; justify-content:center; border:1px solid #eee; border-radius:6px; background:#f9f9f9; }
  .inv-val { font-weight:bold; color:#67b148; }
  .btn-primary { background:#67b148; color:#fff; border:none; border-radius:6px; padding:8px 16px; cursor:pointer; }
  .btn-primary:hover { background:#5a9b3d; }
  .themed-input { border:2px solid #67b148; border-radius:6px; background:transparent; padding:4px 8px; }
  .inv-section { max-width: 900px; margin: 0 auto 16px; }
  .inv-section form { display: flex; justify-content: center; align-items: center; gap: 10px; }
</style>
{% endblock %}
{% block content %}
<h1 style="text-align:center; color:#67b148; margin-bottom:2rem;">Update Inventory</h1>

<div class="inv-section">
  <form method="get" action="/inventory">
    <label for="category_id" style="font-weight:bold; font-size:1.1rem;">Category</label>
    <select id="category_id" name="category_id" style="min-width: 300px; padding: 8px 12px; border: 2px solid #67b148; border-radius: 6px; background: white; font-size: 1rem; color: #333;"></select>
  </form>
</div>

<!-- Bulk inventory receive -->
<form id="inventory-form" method="POST" action="/inventory/update" enctype="multipart/form-data" style="max-width: 900px; margin: 0 auto;">
  <input type="hidden" name="category_id" value="{{ selected_category or '' }}">
  <div id="products-container">
    <!-- Products will be dynamically rendered here -->
  </div>
  <div style="text-align: right; margin-top: 20px;">
    <button type="submit" id="save-changes-btn" class="btn-primary" style="padding:10px 24px; font-size:1.1rem;">Apply Inventory</button>
  </div>
</form>

{% endblock %}
{% block scripts %}
<script id="categories-data" type="application/json">{{ categories | default([]) | tojson }}</script>
<script id="selected-category" type="application/json">{{ selected_category | default('null') | tojson }}</script>
<script id="products-data" type="application/json">{{ products | default([]) | tojson }}</script>
<script>
  const categoriesData = JSON.parse(document.getElementById('categories-data').textContent || '[]');
  const selectedCategory = JSON.parse(document.getElementById('selected-category').textContent || 'null');
  const productsData = JSON.parse(document.getElementById('products-data').textContent || '[]');

  function populateCategorySelect(selectEl, includeAll) {
    selectEl.innerHTML = '';
    if (includeAll) {
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = '-- All Categories --';
      selectEl.appendChild(optAll);
    }
    categoriesData.forEach(([id, name]) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
  }

  function createProductCard(product) {
    const [id, name, price, image, inventory] = product;
    const card = document.createElement('li');
    card.className = 'inv-card';
    card.setAttribute('data-id', id);
    
    card.innerHTML = `
      <div class="inv-thumb">
        ${image ? `<img src="${image}" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : ''}
      </div>
      <div style="flex: 1 1 200px; min-width: 100px; display:flex; flex-direction:column;">
        <div style="font-weight:bold;">${name}</div>
        <div style="color:#666; font-size:0.9rem;">Price: ${price} | In Stock: <span class="inv-val">${inventory}</span></div>
      </div>
      <input type="hidden" name="product_id" value="${id}">
      <div style="display:flex; flex-direction:column; align-items:flex-end;">
        <label style="font-size:0.95rem; color:#555; margin-bottom:2px;">Receive Qty</label>
        <input class="receive-qty" type="number" name="received_qty" value="0" min="0" style="width: 90px; text-align:right; border: 2px solid #67b148; border-radius:6px; background:transparent; padding:4px 8px;">
      </div>
    `;
    
    return card;
  }

  function renderProducts(filterCatId) {
    const container = document.getElementById('products-container');
    container.innerHTML = '';
    
    let filtered;
    if (!filterCatId || filterCatId === '') {
      // Show all products when "All Categories" is selected
      filtered = productsData;
    } else {
      // Filter by category
      filtered = productsData.filter(p => String(p[5]) === String(filterCatId));
    }
    
    if (!filterCatId || filterCatId === '') {
      // Group products by category and show headers
      const productsByCategory = {};
      filtered.forEach(product => {
        const [id, name, price, image, inventory, category_id] = product;
        const category = categoriesData.find(([cid, cname]) => String(cid) === String(category_id))?.[1] || 'Unknown';
        if (!productsByCategory[category]) {
          productsByCategory[category] = [];
        }
        productsByCategory[category].push(product);
      });
      
      // Render with category headers
      Object.entries(productsByCategory).forEach(([categoryName, categoryProducts]) => {
        const header = document.createElement('h3');
        header.textContent = categoryName;
        header.style.margin = '20px 0 10px 0';
        header.style.color = '#67b148';
        header.style.borderBottom = '2px solid #67b148';
        header.style.paddingBottom = '5px';
        container.appendChild(header);
        
        const categoryList = document.createElement('ul');
        categoryList.style.listStyle = 'none';
        categoryList.style.padding = '0';
        categoryList.style.maxWidth = '900px';
        categoryList.style.margin = '0 auto';
        
        categoryProducts.forEach(product => {
          categoryList.appendChild(createProductCard(product));
        });
        
        container.appendChild(categoryList);
      });
    } else {
      // Just show the list of products for selected category
      const productList = document.createElement('ul');
      productList.style.listStyle = 'none';
      productList.style.padding = '0';
      productList.style.maxWidth = '900px';
      productList.style.margin = '0 auto';
      
      filtered.forEach(product => {
        productList.appendChild(createProductCard(product));
      });
      
      container.appendChild(productList);
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Top filter
    const filterSel = document.getElementById('category_id');
    populateCategorySelect(filterSel, true);
    if (selectedCategory) filterSel.value = String(selectedCategory);
    
    // Initial render
    renderProducts(selectedCategory || '');
    
    // Auto-filter when category changes
    filterSel.addEventListener('change', function() {
      const selectedValue = this.value;
      renderProducts(selectedValue || '');
      window.location.href = '/inventory?category_id=' + (selectedValue || '');
    });

    // Prevent Enter from accidentally submitting in per-row inputs; use Apply Inventory instead
    document.getElementById('inventory-form').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && ['INPUT', 'TEXTAREA'].includes(e.target.tagName) && e.target.type !== 'file') {
        e.preventDefault();
        document.getElementById('save-changes-btn').click();
      }
    });
  });
</script>
{% endblock %}
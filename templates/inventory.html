{% extends "base.html" %}
{% block title %}Update Inventory{% endblock %}
{% block extra_head %}
<style>
  .inv-card {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    background: #fff;
  }

  .inv-thumb {
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #eee;
    border-radius: 6px;
    background: #f9f9f9;
  }

  .inv-val {
    font-weight: bold;
    color: #67b148;
  }

  .btn-primary {
    background: #67b148;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    cursor: pointer;
  }

  .btn-primary:hover {
    background: #5a9b3d;
  }

  .themed-input {
    border: 2px solid #67b148;
    border-radius: 6px;
    background: transparent;
    padding: 4px 8px;
  }

  .inv-section {
    max-width: 900px;
    margin: 0 auto 16px;
  }

  .inv-section form {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* --- Green Tom Select Simplified Styling --- */
  #category_id {
    display: none;
  }

  /* Hide original */

  /* The Box */
  .ts-control {
    border: 2px solid #67b148 !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 1.15rem !important;
    min-height: 46px;
    background: white;
    display: flex;
    align-items: center;
  }

  /* The Input (Searching) */
  .ts-control input {
    font-size: 1.15rem !important;
    flex: 1;
  }

  /* The Selected Item (Text only, no chips) */
  .ts-control .item {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
    font-size: 1.15rem !important;
    color: #333 !important;
  }

  /* Dropdown */
  .ts-dropdown {
    border: 2px solid #67b148;
    margin-top: 5px;
    font-size: 1.15rem;
    z-index: 1000;
  }

  .ts-dropdown .active {
    background-color: #f0f8f0;
    color: #67b148;
  }
</style>
{% endblock %}
{% block content %}
<h1 style="text-align:center; color:#67b148; margin-bottom:2rem; font-size: 2rem;">Actualizar Inventario</h1>

{# Flash messages #}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div style="max-width:900px;margin:0 auto 1em;">
  {% for category, message in messages %}
  <div class="flash {{ 'error' if category == 'error' else 'success' }}"
    style="padding: 1em; border-radius: 6px; margin-bottom: 0.75em; color: #fff; font-weight: bold;">
    {{ message }}
  </div>
  {% endfor %}
  <script>
    setTimeout(() => { document.querySelectorAll('.flash').forEach(el => el.style.display = 'none'); }, 4500);
  </script>
</div>
{% endif %}
{% endwith %}

<div class="inv-section">
  <!-- Replaced Form to use Client-Side Filtering with Tom Select -->
  <label for="category_id"
    style="font-weight:bold; font-size:1.25rem; display:block; margin-bottom: 8px;">Categoría</label>
  <select id="category_id" name="category_id">
    <option value="">Todas las Categorías</option>
  </select>
</div>

<!-- Bulk inventory receive -->
<form id="inventory-form" method="POST" action="/inventory/update" enctype="multipart/form-data"
  style="max-width: 900px; margin: 0 auto;">
  <input type="hidden" name="category_id" value="{{ selected_category or '' }}">
  <div id="products-container"></div>
  <div style="text-align: right; margin-top: 20px;">
    <button type="submit" id="save-changes-btn" class="btn-primary"
      style="padding:10px 24px; font-size:1.25rem;">Aplicar Inventario</button>
  </div>
</form>

{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/tom-select.min.js') }}"></script>
<script id="categories-data" type="application/json">{{ categories | default([]) | tojson }}</script>
<script id="selected-category" type="application/json">{{ selected_category | default('null') | tojson }}</script>
<script id="products-data" type="application/json">{{ products | default([]) | tojson }}</script>
<script>
  const categoriesData = JSON.parse(document.getElementById('categories-data').textContent || '[]');
  const selectedCategory = JSON.parse(document.getElementById('selected-category').textContent || 'null');
  const productsData = JSON.parse(document.getElementById('products-data').textContent || '[]');

  function createProductCard(product) {
    const [id, name, price, image, inventory] = product;
    const card = document.createElement('li');
    card.className = 'inv-card';
    card.setAttribute('data-id', id);

    card.innerHTML = `
      <div class="inv-thumb">
        ${image ? `<img src="${image}" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : ''}
      </div>
      <div style="flex: 1 1 200px; min-width: 100px; display:flex; flex-direction:column;">
        <div style="font-weight:bold;">${name}</div>
        <div style="color:#666; font-size:1rem;">Precio: ${price} | En Stock: <span class="inv-val">${inventory}</span></div>
      </div>
      <input type="hidden" name="product_id" value="${id}">
      <div style="display:flex; flex-direction:column; align-items:flex-end;">
        <label style="font-size:1.05rem; color:#555; margin-bottom:2px;">Cantidad a Recibir</label>
        <input class="receive-qty" type="number" name="received_qty" value="0" min="0" style="width: 90px; text-align:right; border: 2px solid #67b148; border-radius:6px; background:transparent; padding:4px 8px;">
      </div>
    `;
    return card;
  }

  function renderProducts(filterCatId) {
    const container = document.getElementById('products-container');
    container.innerHTML = '';

    let filtered;
    if (!filterCatId || filterCatId === '') {
      filtered = productsData;
    } else {
      filtered = productsData.filter(p => String(p[5]) === String(filterCatId));
    }

    if (!filterCatId || filterCatId === '') {
      // Group products by category
      const productsByCategory = {};
      filtered.forEach(product => {
        const [id, name, price, image, inventory, category_id] = product;
        const key = String(category_id);
        if (!productsByCategory[key]) productsByCategory[key] = [];
        productsByCategory[key].push(product);
      });

      // Render headers
      categoriesData.forEach(([cid, cname]) => {
        const list = productsByCategory[String(cid)];
        if (!list || list.length === 0) return;

        const header = document.createElement('h3');
        header.textContent = cname;
        header.style.margin = '20px 0 10px 0';
        header.style.color = '#67b148';
        header.style.borderBottom = '2px solid #67b148';
        header.style.paddingBottom = '5px';
        header.style.fontSize = '1.5rem';
        container.appendChild(header);

        const categoryList = document.createElement('ul');
        categoryList.style.listStyle = 'none';
        categoryList.style.padding = '0';
        categoryList.style.maxWidth = '900px';
        categoryList.style.margin = '0 auto';

        list.forEach(product => {
          categoryList.appendChild(createProductCard(product));
        });
        container.appendChild(categoryList);
      });
    } else {
      // Just show list
      const productList = document.createElement('ul');
      productList.style.listStyle = 'none';
      productList.style.padding = '0';
      productList.style.maxWidth = '900px';
      productList.style.margin = '0 auto';
      filtered.forEach(product => {
        productList.appendChild(createProductCard(product));
      });
      container.appendChild(productList);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // 1. Setup Options
    const selectEl = document.getElementById('category_id');
    categoriesData.forEach(([id, name]) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });

    // 2. Initialize Clean "Snap-To" Tom Select
    new TomSelect('#category_id', {
      create: false,
      sortField: { field: "text", direction: "asc" },
      allowEmptyOption: true,
      maxItems: 1,
      onChange: function (value) {
        renderProducts(value || '');
      },
      // Logic to clear input on click (fixes lagging/freezing)
      onFocus: function () {
        this.clear(true);
      }
    });

    // 3. Initial Render
    renderProducts(selectedCategory || '');

    // Prevent enter key submission
    document.getElementById('inventory-form').addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && ['INPUT', 'TEXTAREA'].includes(e.target.tagName) && e.target.type !== 'file') {
        e.preventDefault();
        document.getElementById('save-changes-btn').click();
      }
    });
  });
</script>
{% endblock %}
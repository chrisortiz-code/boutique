{% extends "base.html" %}
{% block title %}Manage Categories & Products{% endblock %}
{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='tom-select.css') }}">
<style>
  .section { border: 2px solid #67b148; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
  .title { font-size: 1.1rem; font-weight: bold; color: #67b148; margin-bottom: 0.5rem; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  .cat-header { display:flex; justify-content:space-between; align-items:center; }
  .cat-name { font-size: 1.15rem; font-weight: 700; color: #67b148; }
  .cat-actions { display:flex; gap:8px; }
  .btn { border:none; border-radius:6px; padding:6px 12px; color:#fff; cursor:pointer; }
  .btn-edit { background:#67b148; }
  .btn-edit:hover { background:#5a9b3d; }
  .btn-delete { background:#e74c3c; }
  .btn-add { background:#67b148; }
  .btn-add:hover { background:#5a9b3d; }
  .product-row { cursor: move; }
  .product-row.dragging { opacity: 0.4; background-color: #f0f8f0; }
  .sortable-tbody { min-height: 50px; }
</style>
{% endblock %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div style="max-width:600px;margin:1em auto;">
  {% for category, message in messages %}
  <div class="flash {{ 'error' if category == 'error' else 'success' }}" style="padding: 1em; border-radius: 6px; margin-bottom: 1em; color: #fff; font-weight: bold;">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}
{% endwith %}

{# Listing categories each with products and actions #}
{% for cid, cname in categories %}
<div class="section">
  <div class="cat-header">
    <div class="cat-name">{{ cname }}</div>
    <div class="cat-actions">
      <form method="post" action="/manage/update_category" style="display:flex; gap:6px; align-items:center;">
        <input type="hidden" name="category_id" value="{{ cid }}">
        <input type="text" name="new_name" placeholder="Rename" style="padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
        <button type="submit" class="btn btn-edit">Rename</button>
      </form>
      <form method="post" action="/manage/delete_category" onsubmit="return confirm('Delete this category? You must move or delete its products first.')">
        <input type="hidden" name="category_id" value="{{ cid }}">
        <button type="submit" class="btn btn-delete">Delete</button>
      </form>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>Price</th>
        <th>Inventory</th>
        <th>Move To</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody class="sortable-tbody" data-category-id="{{ cid }}">
    {% for id, name, price, image, inventory in products_by_category.get(cid, []) %}
      <tr class="product-row" data-product-id="{{ id }}" draggable="true">
        <td style="width:120px;">
          {% if image %}<img src="{{ image }}" alt="{{ name }}" style="max-width:80px; max-height:80px; object-fit:contain;">{% endif %}
          <input type="file" name="image_{{ id }}" accept="image/*" style="width:100%; font-size:0.8rem; margin-top:4px;">
        </td>
        <td>
          <input type="text" name="name_{{ id }}" value="{{ name }}" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
        </td>
        <td>
          <input type="number" name="price_{{ id }}" value="{{ price }}" style="width:100%; padding:4px; border:1px solid #ccc; border-radius:4px;">
        </td>
        <td>{{ inventory }}</td>
        <td>
          <form method="post" action="/products/bulk_update" style="display:flex; gap:6px; align-items:center;">
            <input type="hidden" name="id" value="{{ id }}">
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="price" value="{{ price }}">
            <input type="hidden" name="position" value="0">
            <input type="hidden" name="return_category_id" value="{{ cid }}">
            <select name="new_category_id" class="move-select" data-product-id="{{ id }}" style="min-width: 180px;"></select>
            <button type="submit" class="btn btn-edit">Move</button>
          </form>
        </td>
        <td>
          <form method="post" action="/manage/update_product" enctype="multipart/form-data" style="display:flex; gap:6px; align-items:center;">
            <input type="hidden" name="product_id" value="{{ id }}">
            <input type="hidden" name="return_category_id" value="{{ cid }}">
            <input type="hidden" name="name" id="name_input_{{ id }}" value="{{ name }}">
            <input type="hidden" name="price" id="price_input_{{ id }}" value="{{ price }}">
            <input type="hidden" name="image_file" id="image_file_{{ id }}">
            <button type="submit" class="btn btn-edit" data-product-id="{{ id }}" onclick="prepareUpdate(this.dataset.productId)">Update</button>
          </form>
          <form method="POST" action="/products/delete" onsubmit="return confirm('Delete this product?');" style="margin-top:4px;">
            <input type="hidden" name="name" value="{{ name }}">
            <input type="hidden" name="return_category_id" value="{{ cid }}">
            <button type="submit" class="btn btn-delete">Delete</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <div class="title" style="margin-top: 1rem;">Add Product to {{ cname }}</div>
  <form action="/manage/add_product" method="post" enctype="multipart/form-data" style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items:center;">
    <input type="hidden" name="category_id" value="{{ cid }}">
    <div style="display:flex; flex-direction:column;">
      <label style="font-size:0.95rem; color:#555; margin-bottom:2px;">Name</label>
      <input type="text" name="name" required class="themed-input" style="font-weight:bold; border:2px solid #be4272; border-radius:6px; background:transparent; font-size:1rem; padding:4px 8px;">
    </div>
    <div style="display:flex; flex-direction:column;">
      <label style="font-size:0.95rem; color:#555; margin-bottom:2px;">Price</label>
      <input type="number" name="price" required class="themed-input" style="text-align:right; border:2px solid #be4272; border-radius:6px; background:transparent; padding:4px 8px;">
    </div>
    <div style="display:flex; flex-direction:column;">
      <label style="font-size:0.95rem; color:#555; margin-bottom:2px;">Start Inventory</label>
      <input type="number" name="start_inventory" value="0" class="themed-input" style="text-align:right; border:2px solid #be4272; border-radius:6px; background:transparent; padding:4px 8px;">
    </div>
    <div style="display:flex; flex-direction:column;">
      <label style="font-size:0.95rem; color:#555; margin-bottom:2px;">Image
        <input type="file" name="image" accept="image/*" capture="environment" style="width: 180px;">
      </label>
    </div>
    <div>
      <button type="submit" class="btn btn-add">Add</button>
    </div>
  </form>
</div>
{% endfor %}

<div class="section">
  <div class="title">Add New Category</div>
  <form method="post" action="/manage/add_category" style="display:flex; gap:8px; align-items:center;">
    <input type="text" name="category_name" placeholder="New category" style="padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
    <button type="submit" class="btn btn-add">Add Category</button>
  </form>
</div>

{% endblock %}
{% block scripts %}
<script src="{{ url_for('static', filename='js/tom-select.min.js') }}"></script>
<script id="categories-data" type="application/json">{{ categories | default([]) | tojson }}</script>
<script>
  const categories = JSON.parse(document.getElementById('categories-data').textContent || '[]');
  let draggedElement = null;
  
  function prepareUpdate(productId) {
    // Get the current values from the input fields
    const nameInput = document.querySelector(`input[name="name_${productId}"]`);
    const priceInput = document.querySelector(`input[name="price_${productId}"]`);
    const imageInput = document.querySelector(`input[name="image_${productId}"]`);
    
    // Update the hidden form inputs
    document.getElementById(`name_input_${productId}`).value = nameInput.value;
    document.getElementById(`price_input_${productId}`).value = priceInput.value;
    
    // Handle the file input
    if (imageInput.files.length > 0) {
      // Create a new FormData and append the file
      const form = document.querySelector(`form[action="/manage/update_product"]`);
      const formData = new FormData(form);
      formData.append('image', imageInput.files[0]);
      
      // Submit the form with the file
      fetch('/manage/update_product', {
        method: 'POST',
        body: formData
      }).then(response => {
        if (response.ok) {
          window.location.reload();
        } else {
          alert('Error updating product');
        }
      });
      return false; // Prevent default form submission
    }
    
    return true; // Allow normal form submission
  }
  
  function populateCategorySelect(selectEl) {
    selectEl.innerHTML = '';
    categories.forEach(([id, name]) => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
  }

  // Drag and drop functionality
  function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
  }

  function handleDragOver(e) {
    e.preventDefault();
  }

  function handleDrop(e) {
    e.preventDefault();
    if (draggedElement !== this) {
      const tbody = this.closest('tbody');
      const allRows = [...tbody.children];
      const draggedIndex = allRows.indexOf(draggedElement);
      const droppedIndex = allRows.indexOf(this);
      
      if (draggedIndex < droppedIndex) {
        tbody.insertBefore(draggedElement, this.nextSibling);
      } else {
        tbody.insertBefore(draggedElement, this);
      }
      
      // Update position numbers in database
      updatePositions(tbody);
    }
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
  }

  function updatePositions(tbodyElement) {
    const rows = Array.from(tbodyElement.children);
    const categoryId = tbodyElement.getAttribute('data-category-id');
    
    const positionData = rows.map((row, index) => ({
      id: row.getAttribute('data-product-id'),
      position: index + 1
    }));
    
    // Send position updates to server
    fetch('/manage/update_positions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ positions: positionData, category_id: categoryId })
    }).then(response => {
      if (response.ok) {
        console.log('Positions updated successfully');
      } else {
        console.error('Failed to update positions');
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Set up drag and drop for all product rows
    document.querySelectorAll('.product-row').forEach(row => {
      row.addEventListener('dragstart', handleDragStart);
      row.addEventListener('dragover', handleDragOver);
      row.addEventListener('drop', handleDrop);
      row.addEventListener('dragend', handleDragEnd);
    });

    // Populate category selects
    document.querySelectorAll('select.move-select').forEach(sel => {
      populateCategorySelect(sel);
    });
  });
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Boutique{% endblock %}

{% block extra_head %}
<style>
  /* --- 1. Grid & Product Card Styling --- */
  .grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
  }

  .product {
    text-align: center;
    border: 5px solid #67b148;
    border-radius: 10px;
    padding: 8px;
    background: #fff;
  }

  .product img {
    width: 100%;
    height: auto;
    max-height: 100px;
    object-fit: contain;
  }

  .quantity-controls button {
    padding: 2px 8px;
    background-color: #67b148;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  /* --- 2. Summary & Checkout Styling --- */
  .summary {
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
    border: 1px dashed #aaa;
    border-radius: 8px;
    background: #fff;
  }

  .summary-row {
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }

  .checkout-button {
    background: #67b148;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    width: 100%;
  }

  .checkout-button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  /* --- 3. Tom Select Simplified Green Styling --- */
  #category_filter {
    display: none;
  }

  /* Hide original */

  /* The Box */
  .ts-control {
    border: 2px solid #67b148 !important;
    border-radius: 6px !important;
    padding: 8px 12px !important;
    font-size: 1.15rem !important;
    min-height: 46px;
    background: white;
    display: flex;
    align-items: center;
  }

  /* The Input (Searching) */
  .ts-control input {
    font-size: 1.15rem !important;
    flex: 1;
  }

  /* The Selected Item (Make it look like text, not a tag/chip) */
  .ts-control .item {
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
    margin: 0 !important;
    font-size: 1.15rem !important;
    color: #333 !important;
  }

  /* Dropdown */
  .ts-dropdown {
    border: 2px solid #67b148;
    margin-top: 5px;
    font-size: 1.15rem;
    z-index: 1000;
  }

  .ts-dropdown .active {
    background-color: #f0f8f0;
    color: #67b148;
  }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto;">

  <!-- Search / Filter -->
  <div style="margin-bottom: 20px;">
    <label style="font-weight:bold; font-size:1.25rem; display:block; margin-bottom: 8px;">Category</label>
    <select id="category_filter">
      <option value="">Todas las Categor√≠as</option>
      {% for id, name in categories %}
      <option value="{{ id }}">{{ name }}</option>
      {% endfor %}
    </select>
  </div>

  <form id="orderForm" onsubmit="return false;">
    <!-- Product Grid -->
    <div id="products_grid" class="grid"></div>

    <!-- Cart Summary -->
    <div class="summary" id="summary"></div>

    <!-- Checkout -->
    <button type="button" class="checkout-button" id="checkout-btn" disabled>Checkout</button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tom-select.min.js') }}"></script>
<!-- Inject Data safely -->
<script>
  const CATEGORIES = {{ categories | default ([]) | tojson }};
  const PRODUCTS = {{ products | default ([]) | tojson }};
</script>

<script>
  (function () {
    // --- 1. Data Setup ---
    // Create a fast lookup map for products
    const productsMap = {};
    PRODUCTS.forEach(p => {
      productsMap[p[0]] = { id: p[0], name: p[1], price: p[2], image: p[3], cat_id: p[5] };
    });

    // State
    const cart = {};      // { productId: quantity }
    const discounts = {}; // { productId: percent }

    // --- 2. Initialize Tom Select (Simple & Clean) ---
    let ts = new TomSelect('#category_filter', {
      create: false,
      sortField: { field: "text", direction: "asc" },
      maxItems: 1,
      allowEmptyOption: true,
      onChange: function (val) {
        renderGrid(val);
      }
    });

    // --- 3. Grid Rendering Logic ---
    function renderGrid(filterId) {
      const grid = document.getElementById('products_grid');
      grid.innerHTML = '';

      // Determine which products to show
      let visibleProducts = PRODUCTS;
      if (filterId && filterId !== "") {
        visibleProducts = PRODUCTS.filter(p => String(p[5]) === String(filterId));
      }

      // Logic: If showing "All", group by headers. If showing "One", just list them.
      if (!filterId || filterId === "") {
        // Group by Category Name
        grid.className = ''; // Remove grid class from container to allow headers

        CATEGORIES.forEach(([catId, catName]) => {
          const catProds = visibleProducts.filter(p => String(p[5]) === String(catId));
          if (catProds.length === 0) return;

          // Header
          const h3 = document.createElement('h3');
          h3.textContent = catName;
          h3.style.cssText = 'margin: 20px 0 10px; color: #67b148; border-bottom: 2px solid #67b148; font-size: 1.5rem;';
          grid.appendChild(h3);

          // Sub-grid
          const subGrid = document.createElement('div');
          subGrid.className = 'grid';
          subGrid.style.marginBottom = '30px';
          subGrid.innerHTML = catProds.map(p => getCardHtml(p[0])).join('');
          grid.appendChild(subGrid);
        });
      } else {
        // Single Category View
        grid.className = 'grid';
        grid.innerHTML = visibleProducts.map(p => getCardHtml(p[0])).join('');
      }
    }

    function getCardHtml(pid) {
      const p = productsMap[pid];
      const qty = cart[pid] || 0;
      const imgHtml = p.image ? `<img src="${p.image}" alt="${p.name}">` : `<div style="height:100px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;">No Image</div>`;

      return `
      <div class="product">
        ${imgHtml}
        <div style="font-size:20px; margin:5px 0;">${p.name} ($${p.price})</div>
        <div class="quantity-controls">
          <button type="button" onclick="window.updateQty(${pid}, -1)">-</button>
          <span id="qty-display-${pid}" style="margin:0 10px; font-weight:bold;">${qty}</span>
          <button type="button" onclick="window.updateQty(${pid}, 1)">+</button>
        </div>
      </div>
    `;
    }

    // --- 4. Cart & Discount Logic ---

    // Global handler for Grid buttons
    window.updateQty = function (pid, delta) {
      const current = cart[pid] || 0;
      const next = Math.max(0, current + delta);
      cart[pid] = next;

      // Update Grid Number
      const disp = document.getElementById(`qty-display-${pid}`);
      if (disp) disp.innerText = next;

      // Re-render Summary completely (items added/removed)
      renderSummary();
      checkButton();
    };

    // Global handler for Slider (Optimized: No HTML rebuilding)
    window.updateDiscount = function (pid, val) {
      discounts[pid] = parseInt(val);

      // Update the visual text only
      const p = productsMap[pid];
      const qty = cart[pid];
      const rawTotal = p.price * qty;
      const finalTotal = rawTotal - Math.round(rawTotal * (discounts[pid] / 100));

      // Update specific DOM elements
      document.getElementById(`d-txt-${pid}`).innerText = val + '%';
      document.getElementById(`price-${pid}`).innerHTML = val > 0
        ? `<s style="color:#aaa">$${rawTotal}</s> <b style="color:#67b148">$${finalTotal}</b>`
        : `<b>$${finalTotal}</b>`;

      updateGrandTotal();
    };

    function renderSummary() {
      const container = document.getElementById('summary');
      container.innerHTML = ''; // Reset

      let hasItems = false;

      // Loop through selected items
      Object.keys(cart).forEach(pidStr => {
        const pid = parseInt(pidStr);
        const qty = cart[pid];
        if (qty > 0) {
          hasItems = true;
          const p = productsMap[pid];
          const disc = discounts[pid] || 0;

          // Initial Calculation
          const rawTotal = p.price * qty;
          const finalTotal = rawTotal - Math.round(rawTotal * (disc / 100));

          const row = document.createElement('div');
          row.className = 'summary-row';
          row.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
             <span><strong>${p.name}</strong> x${qty}</span>
             <span id="price-${pid}">
               ${disc > 0 ? `<s style="color:#aaa">$${rawTotal}</s> <b style="color:#67b148">$${finalTotal}</b>` : `<b>$${finalTotal}</b>`}
             </span>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
             <small>Discount:</small>
             <input type="range" min="0" max="25" step="5" value="${disc}" 
                    style="flex:1" oninput="window.updateDiscount(${pid}, this.value)">
             <strong id="d-txt-${pid}" style="color:#67b148; min-width:35px; text-align:right;">${disc}%</strong>
          </div>
        `;
          container.appendChild(row);
        }
      });

      if (hasItems) {
        const totalDiv = document.createElement('div');
        totalDiv.style.cssText = 'display:flex; justify-content:space-between; font-size:1.3rem; margin-top:10px; border-top:2px solid #67b148; padding-top:10px;';
        totalDiv.innerHTML = `<strong>Total:</strong> <strong id="grand-total">$0</strong>`;
        container.appendChild(totalDiv);
        updateGrandTotal();
      }
    }

    function updateGrandTotal() {
      let sum = 0;
      Object.keys(cart).forEach(pid => {
        if (cart[pid] > 0) {
          const p = productsMap[pid];
          const raw = p.price * cart[pid];
          const disc = discounts[pid] || 0;
          sum += (raw - Math.round(raw * (disc / 100)));
        }
      });
      const el = document.getElementById('grand-total');
      if (el) el.innerText = '$' + sum;
    }

    function checkButton() {
      const hasItems = Object.values(cart).some(q => q > 0);
      document.getElementById('checkout-btn').disabled = !hasItems;
    }

    // --- 5. Checkout ---
    document.getElementById('checkout-btn').onclick = async function () {
      const items = [];
      Object.keys(cart).forEach(pid => {
        if (cart[pid] > 0) {
          items.push({
            product_id: parseInt(pid),
            qty: cart[pid],
            discount_percent: discounts[pid] || 0
          });
        }
      });

      try {
        const res = await fetch('/api/purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items })
        });
        if (res.ok) {
          // Prepare receipt data for simple display
          const receipt = items.map(i => {
            const p = productsMap[i.product_id];
            const catName = CATEGORIES.find(c => String(c[0]) === String(p.cat_id))?.[1] || '';
            const finalPrice = (p.price * i.qty) * (1 - i.discount_percent / 100);
            return [p.name, i.qty, finalPrice, catName];
          });
          window.location.href = `/gracias?receipt=${encodeURIComponent(JSON.stringify(receipt))}`;
        } else {
          alert('Error processing order.');
        }
      } catch (e) { alert('Network error'); }
    };

    // Start
    renderGrid("");

  })();
</script>
{% endblock %}